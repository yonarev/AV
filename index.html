<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accediendo a la cámara y tomando fotos</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            background-color: rgb(49, 23, 23);
        }
        .camara {
            margin: 0 auto;
            text-align: center; 
            align-content: center;
            justify-content: center;
        } 
        .camara video {
            max-width: 100vw;
            width: 100vw;
        }
        .camara button {
            font-size: 3em;
            border-radius: 1vw;
        }
        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            color: white;
        }
        form input {
            margin-bottom: 10px;
        }
        form button {
            margin-top: 10px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="camara">
        <div>
            <label for="cameraSelect">Selecciona cámara:</label>
            <select id="cameraSelect">
                <option value="user">Frontal</option>
                <option value="environment" selected>Trasera</option>
            </select>
            <br>
            <video id="videoElement" autoplay="true"></video>
        </div>
        <button id="btnCaptureButton" onclick="takePhoto()">2 Tomar foto</button>
        <button id="btnInputData" onclick="grabaLocalArticulo()">1 Grabar datos</button>
        <button id="btnBrowser" onclick="window.open('./articulos.html');">3 Ver datos</button>
    </div>
    <br>
    <canvas id="canvasElement" style="display: none;"></canvas>

    <form id="dataForm">
        <label for="codigoArticulo">Código del Artículo:</label>
        <input type="text" id="codigoArticulo">
        <button type="button" onclick="confirmField('codigoArticulo')">Confirmar</button>

        <label for="articulo">Nombre del Artículo:</label>
        <input type="text" id="articulo">
        <button type="button" onclick="confirmField('articulo')">Confirmar</button>

        <label for="detalle">Descripción del Artículo:</label>
        <input type="text" id="detalle">
        <button type="button" onclick="confirmField('detalle')">Confirmar</button>

        <label for="stockBodegaCentral">Stock en Bodega Central:</label>
        <input type="text" id="stockBodegaCentral">
        <button type="button" onclick="confirmField('stockBodegaCentral')">Confirmar</button>

        <label for="stockBodega">Stock en Bodega:</label>
        <input type="text" id="stockBodega">
        <button type="button" onclick="confirmField('stockBodega')">Confirmar</button>

        <label for="stockVitrina">Stock en Vitrina:</label>
        <input type="text" id="stockVitrina">
        <button type="button" onclick="confirmField('stockVitrina')">Confirmar</button>

        <label for="stockRepo">Stock Reposicion:</label>
        <input type="text" id="stockRepo">
        <button type="button" onclick="confirmField('stockRepo')">Confirmar</button>

        <label for="stockCritico">Stock Crítico:</label>
        <input type="text" id="stockCritico">
        <button type="button" onclick="confirmField('stockCritico')">Confirmar</button>

        <button type="button" onclick="grabaDatosArticulo(event)">Grabar</button>
    </form>

    <script>
        const video = document.getElementById("videoElement");
        const canvas = document.getElementById("canvasElement");
        const context = canvas.getContext("2d");
        const idArticulo = genIdArt();
        const archivo = `foto${idArticulo}.jpg`;
        const ruta = "/fotos/";
        const rutaYarchivo = ruta + archivo;

        let selectedCamera = "environment"; // Default to the rear camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: selectedCamera, width: 1920, height: 1080, frameRate: 30 } })
            .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Error al acceder a la cámara:", error);
            });
            function takePhoto() {
                const btnCaptureButton = document.getElementById("btnCaptureButton");
                btnCaptureButton.disabled = true;
                selectedCamera = document.getElementById("cameraSelect").value;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: selectedCamera, width: 1920, height: 1080, frameRate: 30 } })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                    })
                    .then(function() {
                        return new Promise(resolve => setTimeout(resolve, 500));
                    })
                    .then(function() {
                        // Ajustar el canvas para asegurar una orientación vertical
                        const aspectRatio = video.videoWidth / video.videoHeight;
                        canvas.width = 1080; // Puedes ajustar este valor según tus necesidades
                        canvas.height = 1920; // Puedes ajustar este valor según tus necesidades

                        // Dibujar el fotograma actual del video
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Convertir la imagen del canvas a formato binario (Blob)
                        canvas.toBlob(function(blob) {
                            const formData = new FormData();
                            formData.append('imagen', blob, archivo);
                            formData.append('idArticulo', idArticulo);

                            fetch('guardar_imagen.php', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log(data);
                                btnCaptureButton.disabled = false;
                                location.reload();
                            })
                            .catch(error => {
                                console.error("Error al enviar la imagen al servidor:", error);
                                btnCaptureButton.disabled = false;
                            });

                        }, 'image/jpeg', 1.0, 'image/jpeg');
                    })
                    .catch(function(error) {
                        console.error("Error al acceder a la cámara:", error);
                        btnCaptureButton.disabled = false;
                    });
            }

        // function takePhoto() {
        //     const btnCaptureButton = document.getElementById("btnCaptureButton");
        //     btnCaptureButton.disabled = true;
        //     selectedCamera = document.getElementById("cameraSelect").value;
        //     navigator.mediaDevices.getUserMedia({ video: { facingMode: selectedCamera, width: 1920, height: 1080, frameRate: 30 } })
        //         .then(function(stream) {
        //             video.srcObject = stream;
        //             video.play();
        //         })
        //         .then(function() {
        //             return new Promise(resolve => setTimeout(resolve, 500));
        //         })
        //         .then(function() {
        //             context.drawImage(video, 0, 0, canvas.width, canvas.height);
        //             canvas.toBlob(function(blob) {
        //                 const formData = new FormData();
        //                 formData.append('imagen', blob, archivo);
        //                 formData.append('idArticulo', idArticulo);

        //                 fetch('guardar_imagen.php', {
        //                     method: 'POST',
        //                     body: formData
        //                 })
        //                 .then(response => {
        //                     if (!response.ok) {
        //                         throw new Error('Network response was not ok');
        //                     }
        //                     return response.json();
        //                 })
        //                 .then(data => {
        //                     console.log(data);
        //                     btnCaptureButton.disabled = false;
        //                     location.reload();
        //                 })
        //                 .catch(error => {
        //                     console.error("Error al enviar la imagen al servidor:", error);
        //                     btnCaptureButton.disabled = false;
        //                 });

        //             }, 'image/jpeg', 1.0, 'image/jpeg');
        //         })
        //         .catch(function(error) {
        //             console.error("Error al acceder a la cámara:", error);
        //             btnCaptureButton.disabled = false;
        //         });
        // }

        function confirmField(fieldId) {
            const inputValue = document.getElementById(fieldId).value;
            // Puedes hacer alguna validación adicional aquí si es necesario
            console.log(`Campo ${fieldId} confirmado: ${inputValue}`);
        }

        function grabaDatosArticulo(event) {
            event.preventDefault()
            const codigoArticulo = document.getElementById("codigoArticulo").value;
            const articulo = document.getElementById("articulo").value;
            const detalle = document.getElementById("detalle").value;
            const stockBodegaCentral = document.getElementById("stockBodegaCentral").value;
            const stockBodega = document.getElementById("stockBodega").value;
            const stockVitrina = document.getElementById("stockVitrina").value;
            const stockRepo = document.getElementById("stockRepo").value;
            const stockCritico = document.getElementById("stockCritico").value;
            const articuloData = {
                idArticulo,
                codigoArticulo,
                articulo,
                detalle,
                stockBodegaCentral,
                stockBodega,
                stockVitrina,
                stockRepo,
                stockCritico,
                archivo,
            };
            const existingArticulos = JSON.parse(localStorage.getItem("articulosVitrina")) || [];
            existingArticulos.push(articuloData);
            localStorage.setItem("articulosVitrina", JSON.stringify(existingArticulos));
            alert("Datos grabados en local storage");
            //valida que el archivo de la foto exista
            verificarExistenciaFoto(archivo)
            .then(existe => {
                if (!existe) {
                    alert("La foto no existe en la ruta './fotos/'.");
                    console.log("La foto no existe en la ruta './fotos/'.");
                } else {
                    document.getElemenÄtById("dataForm").reset();
                }
            });
           
        }

        function genIdArt() {
            const currentDate = new Date();
            const hora = currentDate.getHours();
            const minutos = currentDate.getMinutes();
            const segundos = currentDate.getSeconds();
            const hor = hora < 10 ? "0" + hora.toString() : hora.toString();
            const min = minutos < 10 ? "0" + minutos.toString() : minutos.toString();
            const seg = segundos < 10 ? "0" + segundos.toString() : segundos.toString();
            const horaTrans = hor + min + seg;
            const horaIng = hor + ":" + min + ":" + seg;
            const anioHoy = currentDate.getFullYear();
            const mesHoy = ("0" + (currentDate.getMonth() + 1)).slice(-2);
            const diaDeHoy = ("0" + currentDate.getDate()).slice(-2);
            const fechaIng = `${diaDeHoy}/${mesHoy}/${anioHoy}`;
            const id = fechaIng.replace(/\//g, '') + horaIng.replace(/:/g, '');
            return id;
        }

        function verificarExistenciaFoto(archivo) {
            return fetch(`verificar_foto.php?archivo=${archivo}`)
                .then(response => response.json())
                .then(data => {
                    return data.existe;
                })
                .catch(error => {
                    console.error("Error al verificar la existencia de la foto:", error);
                    return false;
                });
        }

        function confirmField(fieldId) {
            const inputValue = document.getElementById(fieldId).value;
            // Puedes hacer alguna validación adicional aquí si es necesario
            console.log(`Campo ${fieldId} confirmado: ${inputValue}`);
        }
    </script>
</body>
</html>
